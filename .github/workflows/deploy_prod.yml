name: Deploy sendme frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SERVER_HOST: ${{ secrets.IP }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SERVER_USER: ${{ secrets.USER }}
      FRONTEND_PATH: /var/www/vhosts/new.sendme123.com

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: ðŸ“¦ Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install --no-optional
          npm install @rollup/rollup-linux-x64-gnu

      - name: ðŸ”¨ Build Vue App
        run: npm run build

      - name: ðŸ“‚ Copy build files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.IP }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          source: 'dist/*'
          strip_components: 1
          target: '/var/www/vhosts/new.sendme123.com/'

      - name: âš¡ Install & Configure Nginx + SSL
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.IP }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            # ðŸ”„ Actualizar paquetes
             apt update &&  apt upgrade -y

            # ðŸŒ Instalar Nginx si no estÃ¡ presente
            if ! command -v nginx &> /dev/null
            then
                echo "ðŸ”§ Instalando Nginx..."
                 apt install -y nginx
            else
                echo "âœ… Nginx ya estÃ¡ instalado."
            fi

            # ðŸ“ Crear directorio del sitio si no existe
             mkdir -p /var/www/vhosts/new.sendme123.com

            # âœ… Dar permisos correctos
             chown -R www-data:www-data /var/www/vhosts/new.sendme123.com
             chmod -R 755 /var/www/vhosts/new.sendme123.com

            # ðŸ”§ Configurar Nginx temporalmente sin SSL
            echo 'server {
                listen 80;
                server_name new.sendme123.com;
                
                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }

                location / {
                    root /var/www/vhosts/new.sendme123.com;
                    index index.html;
                    try_files $uri /index.html;
                }
            }' |  tee /etc/nginx/sites-available/sendme123

            # ðŸ”— Habilitar configuraciÃ³n temporal en Nginx
             ln -sf /etc/nginx/sites-available/sendme123 /etc/nginx/sites-enabled/

            # ðŸ”„ Verificar configuraciÃ³n de Nginx antes de reiniciar
             nginx -t &&  systemctl restart nginx || exit 1

            # ðŸ” Instalar Certbot para SSL si no estÃ¡ instalado
            if ! command -v certbot &> /dev/null
            then
                echo "ðŸ”§ Instalando Certbot..."
                 apt install -y certbot python3-certbot-nginx
            else
                echo "âœ… Certbot ya estÃ¡ instalado."
            fi

            # ðŸ“œ Generar certificado SSL si no existe
            if [ ! -d "/etc/letsencrypt/live/new.sendme123.com" ]; then
                certbot certonly --webroot -w /var/www/html -d new.sendme123.com --non-interactive --agree-tos -m tuemail@sendme.com
            else
               echo "âœ… Certificado SSL ya existente."
            fi

            # ðŸ“œ Configurar Nginx con SSL
            echo 'server {
                listen 80;
                server_name new.sendme123.com;
                location / {
                    return 301 https://$host$request_uri;
                }
            }

            server {
                listen 443 ssl;
                server_name new.sendme123.com;

                root /var/www/vhosts/new.sendme123.com;
                index index.html;

                location / {
                    try_files $uri /index.html;
                }

                location /api/ {
                    proxy_pass http://localhost:4000/api/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                }

                location /socket.io/ {
                    proxy_pass http://localhost:4000/socket.io/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                }
                
                location /opensearch/ {
                    proxy_pass http://localhost:5602/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                }

                ssl_certificate /etc/letsencrypt/live/new.sendme123.com/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/new.sendme123.com/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            }' |  tee /etc/nginx/sites-available/sendme123

            # ðŸ”— Habilitar configuraciÃ³n SSL en Nginx
             ln -sf /etc/nginx/sites-available/sendme123 /etc/nginx/sites-enabled/

            # ðŸ”„ Verificar configuraciÃ³n antes de reiniciar Nginx
             nginx -t &&  systemctl restart nginx || exit 1

            echo "ðŸŽ‰ Despliegue y configuraciÃ³n con SSL completados exitosamente."
